---
layout: post
title:  "Firebase 안드로이드 네이티브 플러그인을 Unity에 적용해보기"
date:   2017-02-13 20:03:51 +0900
categories: blog
tags : [Unity, Android, Firebase, FCM]
---

 유니티는 사람들이 상당히 많이 쓰는 게임 개발 도구 중 하나다. 최근 회사에서 유니티에 안드로이드 푸쉬 기능을 포함한 플러그인을 개발해야 하는 일이 생겼고, 이에 대한 개발을 진행하면서 겪은 것을 공유하려고 한다.

 기본적으로 안드로이드 푸쉬 시스템은 Firebase Cloud Messaging 서비스를 이용하는 것을 권장한다. [fcm 권장하는 글 써있는 안드로이드 페이지 링크] Unity로 개발을 하더라도, 최신의 푸쉬 기능을 지원받기 위해서는 FCM을 적용해야 했다. 매우 운 좋게도, Unity Firebase Plugin이 존재했다!!! 사용 방법도 기가막히게 좋았다. 아주 쉽고 편하게 적용하려고 했으나........

 Build Fail

 인터페이스는 매우 훌륭했으나 크게 두가지 문제가 있었는데
 1) 빌드가 안됨
 2) 빌드를 잘 되게 삽질을 해보았으나 잘 작동이 안됨.

 여기에서, Firebaes 내부 소스를 뜯어볼 수 있는 상황도 아니었기 때문에 내가 이 Unity플러그인을 디버깅 할 수는 없다.

 최근 Cookierun Ovenbreak 를 개발하면서 Android Firebase 플러그인을 Android native에 매우 잘 적용했던 기억이 났다. 인터페이스도 매우 훌륭했고, 추상화도 꽤 잘 되어있었으며, 유저가 코드를 적용하고 사용하는데 매우 부담이 없도록 가이드 되어있다. 서비스 운영을 하면서 푸쉬 관련 이슈가 생긴적이 딱히 없었으니 기능에 있어서도 큰 문제가 없음이 검증되었다. 이것을 그냥 가지고 올 수는 없을까? 해당 플러그인을 유니티에서 사용할 수 있도록 한다면, 현재 서비스중인 cookierun ovenbreak에서 사용하는 푸쉬 관련 소스코드도 활용할 수 있게 된다.

 그래서, Firebase Plugin for Unity를 Android Native Firebase Plugin을 이용하여 만들어보기로 했다.


 Harsh point
 - firebase 가이드를 보면 알겠지만, 그냥 gradle 스크립트에 compile '파이어베이스!'  한 줄만 추가하면 모든 컴파일 과정이 다 자동으로 이뤄진다. dependency 체크 이런거 gradle에서 다 해준다.
 - Dependency가 있는 모든 라이브러리를 찾았다고 하더라도, firebase가 어떤 마법을 부려 자동으로 인증을 하고 push token을 가져오는지 제대로 설명해놓은 문서가 없었다.
 - Unity에서 안드로이드 라이브러리 파일을 어떻게 연결시켜서 빌드시키는지 깔끔하게 설명해 놓은 문서가 없었다.

 이건 뭐 암울함의 끝인게, 진짜 뭐 하나 제대로 설명한게 없었다. 결국 하나부터 열 까지 직접 다 삽질을 통해 찾아가며 개발을 해야 했다.


 이후 순서
 
 1. firebase 작동 원리
 
 처음 앱이 실행되면 manifest에 등록되어있는 firebase provider가 돌아가기 시작한다. 여기에서 firebase app을 초기화 시키고, 성공하면 push token을 받을 수 있는 상태가 된다. 일반적으로 안드로이드에서 gradle에 한 줄 추가하는 방식으로 firebase를 추가하면, firebase app 이 포함된 라이브러리가 빌드에 포함되는데, 여기에 앞에서 말한 firebase provider가 정의되어있다. 사용자의 눈에 보이지 않게 몰래 슥 들어가서 제 역할을 하게 되는 것이다. 때문에 이를 추가하는 유저의 입장에서는, gradle 스크립트에 firebase mesaging 컴파일 하라고 한 줄 등록하고 push message handler만 세팅하면 자동으로 앱이 푸쉬 토큰을 세팅하고 푸쉬를 받을 수 있는 상태가 되는 마법을 경험하게 된다.

 하지만 빌드를 할 때 포함시키는 google-service.json 파일에 인증 값이 무언가 잘못되었을 때, 컴파일 단계에서는 이를 알 수 없고 런타임에 문제가 발생한다. 인증이 실패하면 firebase provider가 실행될 때 `Fail`이라는 로그만 한 줄 남고, 어디에서 문제가 생긴건지에 대한 이유는 알려주지 않는다. 

 2. 안드로이드 라이브러리 파일이 어떻게 Unity에 이식되는가
 유니티에서 gradle 빌드를 지원한게 그리 오래되지는 않았다. gradle 스크립트를 활용하여 빌드하도록 한 것에 한정해서 설명하려고 한다.
 유니티 프로젝트를 gradle export를 해보면, app 에 관련된 프로젝트가 생기고, 포함되어있는 라이브러리들이 따로 정리가 되어 gradle에 compile 하도록 설정된다. 즉, android library들은 Android 폴더에 잘 넣어두기만 하면 빌드할 때 해당 라이브러리를 포함하여 자동으로 빌드한다. 여기서 주의할 것은 포함한 라이브러리 간에 dependency중복이 일어나면 빌드가 안된다. 알아서 체크하고 걸러주는 착한 짓은 하지 않더라. 
 라이브러리 파일이 아니더라도, Android 폴더에 들어있는 특정 폴더에 AndroidManifest 파일과 project.properties 파일이 존재하면 새로운 안드로이드 프로젝트로 인식해서, 빌드시 함께 컴파일 한다. 유니티에 firebase를 적용할 때 com.google.firebase 패키지 이름의 안드로이드 프로젝트 안에 인증 관련 xml 파일이 포함되어 함께 빌드되어야 firebase app을 초기화 하는데 문제가 없다. 인증 관련 정보가 들어있는 리소스만을 포함한 작은 안드로이드 프로젝트가 유니티 프로젝트에 함께 포함되어있는 형태라고 생각하면 된다.

 3. 일단 Andorid Plugin을 빌드할 때, push handler와 push token handler를 구현한다. aar로 빌드한다. 이를 유니티 프로젝트에 포함시킨다.

 4. 유니티 프로젝트에 firebase messaging service에 dependency가 걸려있는 모든 라이브러리를 포함시켜서 넣어둔다. 이는 gradle dependecy체크 하는 명령어를 통해서 확인하면 된다. 필요한 aar 파일을 모두 포함시키고, 3에서 만든 aar 파일까지 포함시키면 유니티에서 안드로이드 빌드를 할 때 알아서 잘 링킹해준다.

 5. 2에서 말한 인증 파일이 제대로 들어가지 않는다면 유니티 앱에서 푸쉬 기능이 제대로 동작하지 않는다. 그리고 3과 4에서 사용되는 firebase 인증서는 파일은 서로 다르다. (패키지 이름이 다르기 때문에)

 6. 이게 빌드를 해도 잘 안될 것이다. 유니티에서 기본으로 돌리는 gradle 스크립트에는 android 관련 default 변수에 application id를 설정하지 않는다. 5.5.1p1 버젼에서 추가된 gradle 스크립트 커스터마이징 기능을 활용하여 applicationId를 세팅해줘야 빌드 후 실행이 잘 될 것이다. 이 과정이 빠지면 빌드는 되지만 앱에서 firebase App을 초기화 하다가 앱이 뻗을 것이다. 


 처음 정리하다보니 두서가 없다. 나중에 좀 더 잘 정리해보자. 
